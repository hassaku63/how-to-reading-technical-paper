# Claude Code CLI Slash Command Export — Spec

## 背景 / 目的
- 既存の MCP Server（`paper-reading-mcp`）が公開する Prompts を、Claude Code CLI から直接呼び出せる「Slash Command」形式へエクスポートする。
- 単一のソースオブトゥルース（MCPのPrompt定義）から、開発現場の操作系（CLIコマンド）へ自動同期し、利用の発見性・即時性・一貫性を高める。

## スコープ / 非スコープ
- スコープ
  - MCP Tools を追加し、Prompts → Slash Command 設定ファイル（Markdown）を生成
  - 出力（`.claude/commands/` 配下）への保存、プレビュー、最小限の検証
  - プレースホルダ（`{arg}`）の変換・引数メタのマッピング
  - Claude Code 標準形式（Markdown with YAML frontmatter）での出力
- 非スコープ
  - Claude Code CLI 側の実行エンジン実装
  - 複数フォーマットサポート（Markdown 固定とする）
  - 複雑なフィルタリング機能（全 Prompts を対象とする）

## 生成物
- 出力先: `.claude/commands/` ディレクトリに個別の Markdown ファイル
  - 例: `.claude/commands/rp-survey-reading-flow.md`, `.claude/commands/rp-implementation-reading-flow.md`
- フォーマット: Markdown with YAML frontmatter（Claude Code 標準形式）
- 付帯メタ: 生成時刻、`paper-reading-mcp` の `version.Version`、ハッシュ（再現性/差分検出用途）

## 想定ユースケース
- `/rp-survey-reading-flow`、`/rp-implementation-reading-flow` 等のコマンドから、論文読解フローの起動をワンアクションで行う
- チームで `.claude/commands/` 配下の設定をバージョン管理し、配布・更新を容易化
- Tab補完で `/rp-` 系のコマンドを一括発見、論文読解専用ツールとしての一貫性確保

---

## 追加する MCP Tools（名称・説明・スキーマ）

### Tool: `export_claude_commands`
- 説明: MCP Prompts を Claude Code 用の Slash Command ファイルとしてエクスポートし、`.claude/commands/` に保存する。

入力スキーマ（JSON Schema 風; `type: object`）
```json
{
  "type": "object",
  "properties": {
    "target_dir": {
      "type": "string",
      "description": "出力先ディレクトリ。省略時は .claude/commands/"
    },
    "name_prefix": {
      "type": "string",
      "description": "コマンド名に付与する接頭辞（デフォルト: \"rp-\"、空文字でプレフィックスなし）",
      "default": "rp-"
    },
    "dry_run": {
      "type": "boolean",
      "description": "trueのときファイル保存せず生成内容のみを返す"
    }
  },
  "additionalProperties": false
}
```

出力（Tool Result の `application/json` 相当）
```json
{
  "status": "ok",
  "written": true,
  "paths": [
    ".claude/commands/rp-survey-reading-flow.md",
    ".claude/commands/rp-implementation-reading-flow.md",
    ".claude/commands/rp-output-generation.md",
    ".claude/commands/rp-critical-analysis.md",
    ".claude/commands/rp-comparison-matrix.md"
  ],
  "command_count": 5,
  "version": "0.0.0-skeleton",
  "hash": "sha256:...",
  "preview": null
}
```
- `dry_run: true` の場合、`written: false` かつ `preview` に生成物（文字列）を返す。

### Tool: `preview_claude_commands`
- 説明: Claude Code 用 Slash Command ファイルの生成結果をプレビューし、保存せずに返す（CIや人手確認向け）。

入力スキーマ
```json
{
  "type": "object",
  "properties": {
    "name_prefix": {
      "type": "string",
      "description": "コマンド名に付与する接頭辞（デフォルト: \"rp-\"）",
      "default": "rp-"
    }
  },
  "additionalProperties": false
}
```

出力
```json
{
  "status": "ok",
  "command_count": 5,
  "version": "0.0.0-skeleton",
  "files": [
    {
      "path": ".claude/commands/rp-survey-reading-flow.md",
      "content": "...Markdown content..."
    },
    {
      "path": ".claude/commands/rp-implementation-reading-flow.md",
      "content": "...Markdown content..."
    }
  ]
}
```

---

## マッピング仕様（Prompts → Slash Commands）

### コマンド名
- ファイル名: `prefix + prompt.Name + ".md"`
  - デフォルトプレフィックス: `"rp-"` (read-paper の略)
  - 例: `rp-survey-reading-flow.md`, `rp-implementation-reading-flow.md`
- コマンド名: Claude Code がファイル名から拡張子を除いてコマンド化
  - 例: `/rp-survey-reading-flow`, `/rp-implementation-reading-flow`
- name_prefix オプション: カスタムプレフィックス指定
  - 例: `name_prefix: "paper-"` → `paper-survey-reading-flow.md`
  - 例: `name_prefix: ""` → `survey-reading-flow.md` (プレフィックスなし)

### 説明文
- `prompt.Title` と `prompt.Description` を結合（前者を要約タイトル、後者を詳細）

### 引数
- MCP `PromptArgument` → `argument-hint` へのマッピング:
  - required=true: `<arg_name>` （必須引数）
  - required=false: `[arg_name]` （オプション引数）
  - 順序: 必須引数を先頭に、オプション引数を後続に配置
- プロンプト本文内での引数参照:
  - `${1}`, `${2}`, `${3}`: 位置引数
  - `${N:-default}`: デフォルト値付き位置引数
  - `$ARGUMENTS`: 全引数を一括参照（必要に応じて）
- メタデータ:
  - frontmatter コメントで元の引数名と説明を保持

### 本文テンプレート
- `assets/prompts/*.txt` の本文を使用
- プレースホルダ変換:
  - 位置引数: `{research_domain}` → `${1}` (第1引数)
  - デフォルト値付き: `{time_budget}` → `${3:-15}` (第3引数、デフォルト15)
  - 全引数: `$ARGUMENTS` を使用可能
- 引数マッピングルール:
  - required=true の引数を先頭から順番に配置
  - required=false の引数は後続位置でデフォルト値付き
- 注意: 現行 `assets/embed.go` は `resources/**` のみ embed。`prompts/**` を追加する（実装時に対応）。

### 出力フォーマット（Markdown with YAML frontmatter）

例: `.claude/commands/rp-survey-reading-flow.md`
```markdown
---
description: 研究者が大量の論文を効率的にサーベイするための構造化フロー
argument-hint: <research_domain> <survey_goal> [time_budget]
model: claude-3-5-sonnet-20241022
# Generated by paper-reading-mcp v0.0.0-skeleton
# Source prompt: survey-reading-flow
---

研究分野: ${1}
サーベイ目的: ${2}
時間予算（分）: ${3:-15}

以下の手順で論文をサーベイ観点から読解してください：
[... プロンプト本文 ...]
```

例: `.claude/commands/rp-implementation-reading-flow.md`
```markdown
---
description: ソフトウェアエンジニアが論文のアイデアを実装するための読解フロー
argument-hint: <skill_goals> <current_level> [implementation_timeline]
# Generated by paper-reading-mcp v0.0.0-skeleton
# Source prompt: implementation-reading-flow
---

スキル目標: ${1}
現在レベル: ${2}
実装予定期間: ${3:-1-3ヶ月}

[... プロンプト本文 ...]
```

---

## 実装方針
- 位置: `internal/tools/slash/export.go`（新規）
- サーバ登録: `internal/mcpserver/server.go` で `server.AddTool(...)` を追加
- 取得ロジック:
  1. 既知の登録関数（`internal/prompts/register.go`）の `Prompt` メタを同時管理する内部レジストリを用意
  2. または、SDK側が保持する登録済み Prompts の一覧 API があればそれを参照
  3. テンプレート本文は `assets/prompts/**` を embed して読込
- エクスポート:
  - Markdown 形式: YAML frontmatter + プロンプト本文
  - 各プロンプトを個別ファイルとして `target_dir` に保存
  - `dry_run` 時は文字列返却のみ

### 変更点（既存コード）
- `assets/embed.go`
  - 変更前: `//go:embed resources/**`
  - 変更後: `//go:embed resources/** prompts/**`

---

## バリデーション / エラー
- 構文チェック: 必須フィールド（name/title/description/prompt）
- 引数重複チェック: `args.name` の重複禁止
- プレースホルダ整合性: `${arg}` に変換後、未解決プレースホルダが残る場合は警告
- ファイル出力時: 既存ファイルと差分が無い場合は上書き回避（`written: false`）
- エラー分類:
  - `ENOENT`: テンプレート未埋め込み（embed漏れ）
  - `EPERM`: 出力先ディレクトリの書き込み権限なし

---

## テスト計画
- 単体
  - プレースホルダ変換 `{arg}` → `${N}`
  - 引数マッピング（required/description）
  - ファイル名生成（name_prefix + prompt.Name + ".md"）
- 結合
  - 全Promptsで Markdown ファイル生成 → frontmatter 形式検証
  - `dry_run` のプレビュー確認
  - `name_prefix` のカスタマイズ動作確認
- 回帰
  - 新規Prompt追加時にエクスポートが壊れないこと

---

## ロールアウト手順
1. `assets/embed.go` に `prompts/**` を追加
2. `internal/tools/slash/export.go` を実装し、`server.AddTool` で登録
3. `make build` → デバッグクライアントで `ListTools` から確認
4. `preview_claude_commands` で内容確認
5. `export_claude_commands` で `.claude/commands/*.md` を生成
6. 生成物をコミット/PR、Claude Code CLI で `/rp-survey` 等で呼び出し確認

---

## セキュリティ / 運用
- 書き出し先はワークスペース配下のみに限定
- `out_path` に相対パスのみ許容（`..` 禁止）
- 生成内容に機密を含めない（テンプレートは一般的手順/ガイドの想定）

---

## 今後の拡張
- `PromptArgument` へのメタデータ拡張（デフォルト値、選択肢など）
- コマンドのカテゴリ/タグ別グルーピング
- コマンドエイリアス名の自動生成
- frontmatter への allowed-tools 自動設定
- 逆流（Slash Command → Prompt 生成）の双方向同期

---

## Open Questions
- Prompt本文に例示引数を注入して事前レンダリングするか（現状は `${N}` テンプレートのまま出力）
- コマンド名の長さが実用上問題になるか（Tab補完で解決可能か）
- frontmatter の model フィールドを固定値にするか、設定可能にするか

